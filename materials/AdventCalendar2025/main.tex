%----------
%----------
%----------
\title{述語変換子意味論と余代数}
% \author{饗庭 大地 (Aiba, Daichi)}
\author{こっとん (\href{https://twitter.com/CottonShampoo}{@CottonShampoo}) }
\date{2025年12月20日 土曜日}
%----------
\documentclass[
		% book,
		head_space=20mm,
		foot_space=20mm,
		gutter=10mm,
		line_length=190mm
]{jlreq}
%----------
\input 0_preamble.tex
\usepackage{docmute} %ファイル分割
%----------
\usepackage{stmaryrd}

\begin{document}


\maketitle %タイトル

\vspace{2mm}

\begin{screen}
	\begin{center}
		\href{https://adventar.org/calendars/11397}{Mathematical Logic Advent Calendar 2025}\\の20日目の投稿です。
	\end{center}
\end{screen}

\vspace{4mm}

\begin{screen}
	\begin{center}
		このドキュメントは，見やすく読みまちがえにくい\\ユニバーサルデザインフォントを採用しています。
	\end{center}
\end{screen}

\vspace{3mm}

\tableofcontents %目次


%----------
% \setcounter{part}{-1}
% \setcounter{chapter}{-1}
% \renewcommand{\thepart}{\arabic{part}}
% \renewcommand{\thesection}{\arabic{section}}
\setcounter{section}{-1}
%----------


\clearpage


\section{前置き}

\subsection{この記事が想定する対象読者}


\subsection{この記事の4つの目標}

この記事では、以下の4つのことを目標とします。

\begin{enumerate}
	\item 
	\item 
	\item 
	\item 
\end{enumerate}

% \vspace{3mm}

\subsection{この記事では扱わないこと}


% \vspace{5mm}

\clearpage

\section{ホーア論理と述語変換子}

\textbf{ホーア論理} (Hoare logic) と\textbf{述語変換子} (predicate transformer) は、プログラムの正しさ（意図した挙動をするか、バグがないかどうか）を数学的に検証するための、異なる2つのアプローチです。プログラムの満たしていてほしい性質（仕様）を論理式で記述し、それが満たされているかを論理学的手法を用いて確かめます。

たとえば、以下のような「入力 $N$ に対し、階乗 $N!$ を計算して出力するプログラム」を考えてみましょう。
\begin{framed}
	\begin{verbatim}
		n := N
		k := 1
		while (n>0) {
				k := k*n;
				n := n-1;
		}
	\end{verbatim}
	~\\[-48pt]
\end{framed}

$N$に正の自然数を入力してこのプログラムを実行した後に、事後条件「$k=N!$」を満たしてほしいものとします。ループが何回実行されるかわからない中で、あらゆる入力 $N$ に対してどうやって保証すればよいでしょうか。答えは、各回のループを通過する前後でいつも保存される条件（ループ不変量）「$k\cdot n!=N!$」に注目する、というものです。そうすることで「階乗を出力する」という仕様が必ず満たされることを保証できます。つまり、事後条件を保証するためには、ループ不変量を探せばよいのです。これが\textbf{ホーア論理}の考え方です。

では今度は、この事後条件「$k=N!$」を成り立たせるためには事前条件として何を課す必要があるか、という問題を考えてみましょう。答えは、「$N\geq 0$」です。これを求めるには、事後条件から出発してプログラムを後ろから前へたどり、各代入に応じて条件を置き換える、という操作をする必要があります。ただし、ループは何回実行されるかわからないので、この操作について不動点をとる必要があります。これが\textbf{述語変換子}の考え方です。

\subsection{ホーア論理}

ホーア論理では $\{P\}\,C\,\{Q\}$ という三つ組を使います。これは「事前条件$P$から始めて、プログラム$C$を実行した結果、事後条件$Q$が成り立つ」という関係です。

\begin{definition}
	ホーア論理の導出規則は以下のものからなる。
	\begin{center}	
		\AXC{} \RL{skip}
		\UIC{$\{A\}$ skip $\{A\}$}
		\DisplayProof
		\vspace{12pt}\\
		%%
		\AXC{} \RL{assignment}
		\UIC{$\{A\,[a/x]\}$ $x:=a$ $\{A\}$}
		\DisplayProof
		\vspace{12pt}\\
		%%%
		\AXC{$\{A\}\,P_1\,\{C\}$}
		\AXC{$\{C\}\,P_2\,\{B\}$} \RL{sequential composition}
		\BIC{$\{A\}\,P_1;P_2\,\{B\}$}
		\DisplayProof
		\vspace{12pt}\\
		%%% 
		\AXC{$\{A\land b\}\,P_1\,\{B\}$}
		\AXC{$\{A\land\lnot b\}\,P_2\,\{B\}$} \RL{if}
		\BIC{$\{A\}$ if $b$ then $P_1$ else $P_2$ $\{B\}$}
		\DisplayProof
		\vspace{12pt}\\
		%%%
		\AXC{$\{A\land b\} \,P\, \{A\}$} \RL{while}
		\UIC{$\{A\}$ while $b$ do $P$ $\{A\land\lnot b\}$}
		\DisplayProof
		\vspace{12pt}\\
		%%% 
		\AXC{$A\Rightarrow A'$}
		\AXC{$\{A'\}\,P\,\{B'\}$}
		\AXC{$B'\Rightarrow B$}
		\RL{consequence}
		\TIC{$\{A\}\,P\,\{B\}$}
		\DisplayProof
	\end{center}
\end{definition}

\begin{example}
	たとえば以下のようなものがホーア論理の証明図である。\vspace{5pt}
	\begin{prooftree}
		\AXC{$\substack{x\geq 0 \land x > 0\\\Rightarrow\; x-1\geq 0}$}
		\AXC{}\RL{a}
		\UIC{$\substack{\{x-1\geq 0\}\; x:=x-1 \; \{x\geq 0\} }$} \RL{c}
		\BIC{$\substack{ \{ x\geq 0 \land x > 0\} \; x:=x-1 \; \{x\geq 0\} }$}
		%%%
		\AXC{$\substack{x\geq 0\land \lnot(x>0)\\\Rightarrow\; x\geq 0}$} 
		\AXC{}\RL{a}
		\UIC{$\substack{ \{x\geq 0\}\; x:=x\;\{x\geq 0\} }$} \RL{c}
		\BIC{$\substack{ \{x\geq 0\land\lnot(x>0)\}\; x:=x\; \{x\geq 0\} }$} \RL{i}
		\BIC{$\substack{ \{x\geq 0\} \; \textrm{if } x>0 \textrm{ then } x:=x-1  \textrm { else } x:=x \; \{x\geq 0\} }$}
	\end{prooftree}
\end{example}

% % \begin{example}
% % 	たとえば、冒頭の「階乗を計算するプログラム」のホーア論理による証明図は以下の通り。
% 	\begin{prooftree}
% 		\AXC{$\substack{N\geq 0\\\Rightarrow k\cdot n!=N!}$}
% 		% \AXC{$\substack{\{k\cdot n!=N!\land n>0\}\, k:=k\cdot n\,;\,n:=n-1\,\{k\cdot n!=N!\}}$}
% 		\AXC{$\substack{\{k\cdot n!=N!\,\land\,n>0\}\,k:=k\cdot n\,;\,n:=n-1\,\{k\cdot n!=N!\}}$}
% 		\RL{w}
% 		\UIC{$\substack{\{k\cdot n!=N!\}\,\textrm{while}\,(n>0)\,k:=k\cdot n\,;\,n:=n-1\,\{k\cdot n!=N!\,\land\,n=0\}}$}
% 		\AXC{$\substack{k\cdot n!=N!\,\land\, n=0\\\Rightarrow k=N!}$}
% 		\RL{c}
% 		\TIC{$\substack{\{N\geq 0\}\,\textrm{while}\,(n>0)\, k:=k\cdot n\,;\,n:=n-1\,\{k=N!\}}$}
% 	\end{prooftree}
% 	\begin{prooftree}
% 		\AXC{$\substack{\{N\geq 0\}\,n:=N\,\{n\geq 0\,\land\,n!=N!\}}$}
% 		\AXC{$\substack{\{n\geq 0\,\land\,n!=N!\}\,k:=1\,\{n\geq 0\,\land\,k\cdot n!=N!\}}$}
% 		\AXC{}
% 		\UIC{$\substack{\{n\geq 0\,\land\,k\cdot n!=N!\}\,\textrm{while}\,(n>0)\, k:=k\cdot n\,;\,n:=n-1\,\{k\cdot n!=N!\land n=0\}}$}
% 		\AXC{$\substack{k\cdot n!=N!\,\land\, n=0\\\Rightarrow k=N!}$}
% 		\BIC{$\substack{\{n\geq 0\,\land\,k\cdot n!=N!\}\,\textrm{while}\,(n>0)\, k:=k\cdot n\,;\,n:=n-1\,\{k=N!\}}$}
% 		\TIC{$\substack{\{N\geq 0\}\,n:=N\,;\,k:=1\,;\,\textrm{while}\,(n>0)\, k:=k\cdot n\,;\,n:=n-1\,\{k=N!\}}$}
% 	\end{prooftree}
% % \end{example}

\begin{remark}
	ループ不変量とは、以下のような while 文の証明図に現れる $I$ のこと。つまり、
	% (1) ループの入り口で事前条件によって含意され（$A\Rightarrow I$）、(2) 各回のループの実行時に常に保たれ（$\{I\land\varphi\}\,C\,\{I\}$）、(3) ループの出口で事後条件を含意する（$I\land\lnot\varphi\Rightarrow B$）
	\begin{enumerate}
		\item ループの\kenten{入口}で事前条件によって含意され（$A\Rightarrow I$）、
		\item 各回のループ\kenten{実行時}に常に保たれ（$\{I\land\varphi\}\,C\,\{I\}$）、
		\item ループの\kenten{出口}で事後条件を含意する（$I\land\lnot\varphi\Rightarrow B$）
	\end{enumerate}
	ような論理式$I$のことである。\vspace{5pt}
	\begin{prooftree}
		\AXC{$A\Rightarrow I$}
		\AXC{$\{I\land \varphi\}\,C\,\{I\}$} \RL{while}
		\UIC{$\{I\}\,\textrm{while}\;\varphi\;\textrm{do}\;C\,\{I\land\lnot\varphi\}$}
		\AXC{$I\land \lnot \varphi\Rightarrow B$} \RL{conseq}
		\TIC{$\{A\}\,\textrm{while}\;\varphi\;\textrm{do}\;C\,\{B\}$}
	\end{prooftree}\vspace{5pt}
	先ほどの「階乗を計算するプログラム」のホーア論理による証明図を書くと（長くなるので省略するが）$I$のところに現れる論理式は「$k\cdot n!=N!$」となる。これが先ほどのプログラムの while 文の「ループ不変量」にあたる。
\end{remark}

\subsection{述語変換子}

述語変換子は、述語 $Q$ を別の述語 $wp\llbracket C\rrbracket (Q)$ に変換します。これは「プログラム$C$について、事後条件$Q$を成り立たせる事前条件のうち、論理的含意関係に関して最も弱いもの」、\textbf{最弱事前条件} (weakest precondition) です。

\begin{definition}[述語変換子意味論]
	状態集合を $S$ とする。$S$ 上の述語の集合を $\mathrm{Pred}(S)=\{Q\mid Q:S\to\{0,1\}\}$ と定める。なお、各述語 $Q:S\to\{0,1\}$ は、$Q=\{s\in S\mid s\models Q\}$ だと考えればよい。述語どうしの順序は、含意関係によって定めるものとする。そうすると、$(\mathrm{Pred}(S),\leq)$ は完備束をなす。\[P\leq Q \quad\textrm{iff}\quad P\Rightarrow Q\] プログラム $C$ の述語変換子 (predicate transformer) とは、写像 \[wp\llbracket C\rrbracket:\mathrm{Pred}(S)\to\mathrm{Pred}(S)\] であって単調性 $Q_1\leq Q_2 \;\Rightarrow\; wp\llbracket C\rrbracket(Q_1)\leq wp\llbracket C\rrbracket(Q_2)$ を満たすものである。具体的には以下のように帰納的に定義される。
	\begin{itemize}
		\item $wp\llbracket\textrm{skip}\rrbracket(Q)=Q$
		\item $wp\llbracket x:=a\rrbracket(Q)=Q[a/x]$
		\item $wp\llbracket C_1;C_2\rrbracket(Q)=wp\llbracket C_1\rrbracket(wp\llbracket C_2\rrbracket(Q))$
		\item $wp\llbracket\mathrm{if}\;\varphi\;\mathrm{then}\;C_1\;\mathrm{else}\;C_2\rrbracket(Q)=(\varphi\land wp\llbracket C_1\rrbracket(Q))\lor(\lnot\varphi\land wp\llbracket C_2\rrbracket(Q))$
		\item $wp\llbracket\mathrm{while}\;\varphi\;\mathrm{do}\;C\rrbracket(Q)=\mu X.\,\underbrace{((\varphi\land wp\llbracket C\rrbracket(X))\lor(\lnot\varphi\land Q))}_{\mathrm{loop~characteristic~function~} \Phi_Q(X)}$
	\end{itemize}
\end{definition}

\begin{remark}
	ここで $\mu$ は順序 $\leq$ についての最小不動点をとる操作である。$\Phi_Q:\mathrm{Pred}(S)\to\mathrm{Pred}(S)$ はスコット連続なので、クリーネの不動点定理より、$\displaystyle\mu X.\,\Phi_Q(X)=\bigvee_{n\in\mathbb N}\Phi_Q^n(\bot)$ が得られる。
\end{remark}

\clearpage

\noindent 以上のように、ホーア論理と述語変換子という2つのアプローチがあります。ここで両者を整理しておきましょう。
\[\begin{cases}\{P\}\,C\,\{Q\} & \textrm{Hoare-style}\\P\Rightarrow wp\llbracket C\rrbracket(Q) & \textrm{Dijkstra-style}\end{cases}\]
両者の関係としては、以下が同値になることが知られています。
\[\{P\}\,C\,\{Q\} \quad\;\textrm{iff}\;\quad P\Rightarrow wp\llbracket C\rrbracket(Q)\] 
より詳しく見ると、実は以下の違いがあります。
\begin{itemize}
	\item ホーア三つ組は「関係的」(relational)。 \\
	\quad 各述語 $P$ に対し、$\{P\}\,C\,\{Q\}$ が成り立つような述語 $Q$ は複数ありうる。\\
	\quad 各述語 $Q$ に対し、$\{P\}\,C\,\{Q\}$ が成り立つような述語 $P$ は複数ありうる。
	% \begin{itemize}
	% 	\item 各述語 $P$ に対し、$\{P\}\,C\,\{Q\}$ が成り立つような述語 $Q$ は複数ありうる。
	% 	\item 各述語 $Q$ に対し、$\{P\}\,C\,\{Q\}$ が成り立つような述語 $P$ は複数ありうる。
	% \end{itemize}
	\item 最弱事前条件は「関数的」(functional) \\
	\quad 各述語 $Q$ に対し、述語 $wp\llbracket C\rrbracket(Q)$ は一意に定まる。
	% \begin{itemize}
	% 	\item 各述語 $Q$ に対し、述語 $wp\llbracket C\rrbracket(Q)$ は一意に定まる。
	% \end{itemize}
\end{itemize}
他方、wp から Hoare triple を「再現」することができます。
\begin{itemize}
	\item $\{\,wp\llbracket C\rrbracket(Q)\,\}\,C\,\{Q\}$ はいつでも成り立つ。
\end{itemize}

さて、これら Hoare-style と Dijkstra-style には、それだけでなく、より本質的な違いがあります。それは、部分正当化 (partial correctness) か、全正当性 (total correctness) か、の違いです。

\subsection{部分正当性と全正当性}

プログラムの正しさを検証するうえで、\textbf{部分正当性} (partial correctness) と\textbf{全正当性} (total correctness) という2種類の「正しさ」の考え方があります。ホーア三つ組 $\{P\}\,C\,\{Q\}$ は前者（部分正当性）を主張するものです。ここではさしあたり、後者（全正当性）のほうを $[P]\,C\,[Q]$ と表記して区別することにして、両者の違いを比べてみましょう。
\begin{itemize}
	\item 部分正当性 (partial correctness) \;$\{P\}\,C\,\{Q\}$
	\begin{itemize}
		\item 「事前条件 $P$ から始めて、\kenten{もし}プログラム $C$ が\kenten{停止したら}、その実行結果は事後条件 $Q$ を満たす。」
		\item プログラムが停止しないときには何も保証しない。
	\end{itemize}
	\item 全正当性 (total correctness) \;$[P]\,C\,[Q]$
	\begin{itemize}
		\item 「事前条件 $P$ から始めて、プログラム $C$ が\kenten{必ず停止し}、\kenten{かつ}、その実行結果は事後条件 $Q$ を満たす。」
		\item プログラムの停止性 (termination) も保証する。
	\end{itemize}
\end{itemize}
ホーア三つ組は部分正当性 (partial correctness) なのに対し、述語変換子は全正当性 (total correctness) です。この違いは、while ループの不動点のとり方に端を発しています。述語変換子の while の意味論は、最小不動点で与えられていたことを思い出しましょう。
\[wp\llbracket\mathrm{while}\;\varphi\;\mathrm{do}\;C\rrbracket(Q)=\mu X.\,\underbrace{((\varphi\land wp\llbracket C\rrbracket(X))\lor(\lnot\varphi\land Q))}_{\mathrm{loop~characteristic~function~} \Phi_Q(X)}\]
それに対し、ホーア論理の while 文は、実は、最大不動点によって与えられていたのです！\vspace{5pt}
	\begin{prooftree}
		\AXC{$P\Rightarrow I$}
		\AXC{$\{I\land \varphi\}\,C\,\{I\}$} \RL{while}
		\UIC{$\{I\}\,\textrm{while}\;\varphi\;\textrm{do}\;C\,\{I\land\lnot\varphi\}$}
		\AXC{$I\land \lnot \varphi\Rightarrow Q$} \RL{conseq}
		\TIC{$\{P\}\,\textrm{while}\;\varphi\;\textrm{do}\;C\,\{Q\}$}
	\end{prooftree}\vspace{5pt}

\clearpage

\begin{proposition}
	$L$ を完備束とし、$f:L\to L$ を単調写像とする。このとき、以下の帰結関係（上から下）が成り立つ。\vspace{5pt}
	\begin{center}
	\begin{prooftree}
		\AXC{$p\leq i$} 
		\AXC{$i\leq f(i)$} 
		\AXC{$i\leq q$} 
		\TIC{$p\leq\nu(f(-)\land q)$}
	\end{prooftree}
	\end{center}
\end{proposition}

\begin{proof}
	$\land$ の普遍性より、以下の同値関係が成り立つ。
	\begin{prooftree}
		\AXC{$i\leq f(i)$}
		\AXC{$i\leq q$}
		\doubleLine
		\BIC{$i\leq f(i)\land q$}
	\end{prooftree}
	ナスター・タルスキの定理より、\[\nu(f(-)\land q)=\bigvee\{x\in L\mid x\leq f(x)\land q\}\] であるから、特に任意の $i\in L$ について以下の帰結関係が成り立つ。
	\begin{prooftree}
		\AXC{$i\leq f(i)\land q$}
		\UIC{$i\leq\nu(f(-)\land q)$}
	\end{prooftree}
	ここで、条件 $p\leq i$ と推移性から、最終的に
	\begin{prooftree}
		\AXC{$p\leq i$} 
		\AXC{$i\leq f(i)$} 
		\AXC{$i\leq q$} 
		\TIC{$p\leq\nu(f(-)\land q)$}
	\end{prooftree}
	が得られた。
\end{proof}

\noindent 
ここで、$p$ は事前条件、$q$ は事後条件、$i$ はループ不変量に、おおよそ相当しています。いま、
\begin{itemize}
	\item \fbox{\,$f(i)$\,} を \fbox{\,$\varphi\Rightarrow wp\llbracket C\rrbracket(I)$\,} に読み替える
	\item \fbox{\,$q$\,} を \fbox{\,$\lnot\varphi\Rightarrow Q$\,} に読み替える
\end{itemize}
とすれば、先ほどの while ループの規則に対応していることがわかりやすいのではないかと思います。\vspace{5pt}
\begin{center}
	% \begin{prooftree}
		\AXC{$p\leq i$} 
		\AXC{$i\leq f(i)$} 
		\AXC{$i\leq q$} 
		\TIC{$p\leq\nu(f(-)\land q)$}
		\DisplayProof
	% \end{prooftree}
	\qquad$\leadsto$\qquad
	% \begin{prooftree}
		\AXC{$P\Rightarrow I$}
		\AXC{$\{I\land \varphi\}\,C\,\{I\}$} %\RL{while}
		\UIC{$\{I\}\,\textrm{while}\;\varphi\;\textrm{do}\;C\,\{I\land\lnot\varphi\}$}
		\AXC{$I\land \lnot \varphi\Rightarrow Q$} %\RL{conseq}
		\TIC{$\{P\}\,\textrm{while}\;\varphi\;\textrm{do}\;C\,\{Q\}$}
	% \end{prooftree}\vspace{5pt}
		\DisplayProof
\end{center}\vspace{5pt}
あえて述語変換子の言葉に寄せると、以下のように書くこともできます。
\[P\Rightarrow\nu X.\,((\varphi\Rightarrow wp\llbracket C\rrbracket(X))\land(\lnot\varphi\Rightarrow Q))\]
つまり、同じものについて、ホーア論理では最大不動点 (gfp, $\nu$) を、最弱事前条件では最小不動点 (lfp, $\mu$) をとっていたことがわかります。（なお、述語変換子の中にも、while の部分正当化を行うものもあり、最弱リベラル事前条件 (weakest liberal precondition) と呼ばれます。）

以上のことをまとめると、以下の表の通りです。\\

\begin{center}
	\begin{tabular}{c|c|c}
		\hline
		& Hoare logic & predicate transformer \\ 
		\hline
		gfp & partial correctness & weakest liberal precondition \\
		\hline
		lfp & total correctness & weakest precondition \\ 
		\hline
	\end{tabular}
\end{center}
~\\

さて、この節で扱った述語変換子の考え方は、圏論的に扱うととても見通しがよくなります。そのための準備として、次節では、圏論の関手を使ってプログラムの振舞いを捉える方法について紹介します。

\clearpage

\section{圏論の関手でシステムの振舞いを捉える}

様々な種類の状態遷移システム（例: 二分木グラフ、ストリーム、オートマトン、マルコフ連鎖、マルコフ決定過程など）を圏論的に扱うには、\textbf{余代数} (coalgebra) と呼ばれるものが役立ちます。

\subsection{余代数入門}

\begin{definition}[余代数]
	$\mathbb{C}$ を圏とし、$F:\mathbb{C}\to\mathbb{C}$ を関手とする。$F$-余代数とは、$\mathbb C$ の対象 $X$ と射 $c:X\to F(X)$ の組 $(X,c)$ のことと定める。また、2つの余代数 $(X,c:X\to F(X)),\,(Y,d:Y\to F(Y))$ の間の余代数準同型とは、射 $f:X\to Y$ であって $d\circ f=F(f)\circ c$ を満たすものとする。\vspace{5pt}
	\begin{center}
		\begin{tikzcd}[row sep=2pt, column sep=4pt]
			F(X) \ar[rr,"F(f)"] & & F(Y)\\
			& \rotatebox{-45}{$=$} & \\
			X \ar[uu,"c"] \ar[rr,"f"'] & & Y \ar[uu,"d"']
		\end{tikzcd}
	\end{center}
\end{definition}

\begin{definition}[余代数の圏]
	$F$-余代数の圏を $\Coalg(F)$ と書くことにする。対象が余代数であり、射が余代数準同型であるような圏である。
	% \begin{small}
		\begin{align*}
			\begin{small}
			\left(\begin{array}{ccc}F(X)\\~\;\uparrow{\scriptstyle c}\\X\end{array}\right)\xrightarrow{~~f~~}\left(\begin{array}{ccc}F(Y)\\~\;\uparrow{\scriptstyle d}\\Y\end{array}\right)
			\end{small}
		\end{align*}
	% \end{small}
\end{definition}

\subsection{余代数の様々な例}

\begin{example}
	二分木グラフは、$\Set$ 上の関手 $F(X)=1+(X\times X)$ に対する余代数 $c:X\to F(X)$ として定義される。
	\[c(x)=(x',x'') \qquad\textrm{or}\qquad c(x)=\ast\]
	\begin{center}
		\begin{tikzcd}[row sep=15pt,column sep=6pt]
			& \circled{\hspace*{4pt}$x$\hspace*{4pt}} \ar[ld,shorten=-5pt] \ar[rd,shorten=-5pt] & \\
			 \circled{\hspace*{2pt}$x'$\hspace*{2pt}} && \circled{\hspace*{1pt}$x''$\hspace*{1pt}}
		\end{tikzcd}
		\qquad\qquad 
		\begin{tikzcd}[row sep=15pt,column sep=6pt]
			\circled{\hspace*{4pt}$x$\hspace*{4pt}} \ar[d,shorten=-2pt,"\backslash"marking]\\
			{~~}
		\end{tikzcd}
	\end{center}
\end{example}

\begin{example}
	ストリームは、$\Set$ 上の関手 $F(X)=A\times X$ に対する余代数 $c:X\to F(X)$ として定義される。
	\[c(x)=(\head(x),\tail(x))\]
	たとえば、ストリーム $x=(x_1,x_2,x_3,\dots)$ について、$\head(x)=x_1,\,\tail(x)=(x_2,x_3,\dots)$ である。\vspace{10pt}

	\begin{center}
		\begin{tikzcd}
			{} \ar[r,shorten <=16pt,shorten >= -3pt]&\underset{abbbbb\dots}{\circled{\hspace*{1pt}$q_0$\hspace*{1pt}}} \ar[r,"a"] & \underset{~~bbb\dots}{\underset{~bbbb\dots}{\underset{bbbbb\dots}{\circled{\hspace*{1pt}$q_1$\hspace*{1pt}}}}} \ar[loop right,"b"]
		\end{tikzcd}
	\end{center}
\end{example}

\clearpage

\begin{example}%[決定的オートマトン・非決定的オートマトン]
	% 決定的オートマトンは、余代数 $\gamma:X\to 2\times X^A$ で与えられる。また、
	非決定的オートマトンは、余代数 $\gamma:X\to 2\times\mathcal P(A\times X)$ で与えられる。なお $2=\{\bigcirc,\doublecirc\}$ とする。
	\[\gamma(x)=\left(\doublecirc,\{(a,x'),\dots\}\right)\quad\textrm{or}\quad\gamma(x)=\left(\bigcirc,\{(a,x'),\dots\}\right)\]
	\begin{center} \small
		\begin{tikzcd}[row sep=2pt,column sep=5pt, /tikz/column 2/.append style={column sep={55pt}}, /tikz/column 1/.append style={column sep={15pt}}]
			{} \ar[r]&\circled{$x_1$} \ar[r,"a"] \ar[rd,"b"] & \circled{$x_2$} \ar[loop above,"b"] \ar[r,"c"] & \doublecircled{$x_3$} \\[-2pt]
			&& \circled{$x_4$}\\\\\hline\\\\
			&x_1 \ar[r,mapsto] & \gamma(x_1) \ar[d,equal] \\[4pt]
			&& \{(a,x_2),(b,x_4)\} \ar[r,mapsto] & \{(a,\gamma(x_2)),(b,\gamma(x_4))\} \ar[d,equal] \\[4pt]
			&&& \{(a,\{(b,x_2),(c,x_3)\}),(b,\{\})\} \ar[d,mapsto,"T\lambda_{FX}"]\\[12pt]
			&&& \{\{ (ab,x_2),(ac,x_3) \},\{\}\} \ar[d,mapsto,"\mu_{F^2X}"] \\[12pt]
			&&& \{(ab,x_2),(ac,x_3)\}
		\end{tikzcd}
	\end{center}
	% なお、非決定的オートマトンは、余代数 $\gamma:X\to 2\times\mathcal P(X)^A$ で与えられることもある。この見方をとると「非決定的オートマトンの決定化」（べき集合構成）を扱える。すなわち、非決定的オートマトン $\gamma:X\to\mathcal P(X)^A$ 
	% 		\begin{multicols}{2}
	% 			\begin{center}\small
	% 				\begin{tikzcd}
	% 					{\!\!\!\!} \ar[r,shorten <= 2mm] & \circled{$x_1$} \ar[r,"a",shift left=8pt] \ar[r,"b"] \ar[r,leftarrow,"a",shift right=8pt] \ar[loop above,looseness=2mm,"a"] &\doublecircled{$x_2$} 
	% 				\end{tikzcd}
	% 			\end{center}
	% 			% \begin{align*}
	% 			% 	\gamma(x_1) &=\left[\begin{array}{ccl} a &\mapsto& \{x_1,x_2\}\\ b&\mapsto &\{x_1\}\end{array}\right] \\
	% 			% 	\gamma(x_2) &=\left[\begin{array}{ccl} a &\mapsto& \emptyset\\ b&\mapsto &\emptyset\end{array}\right]
	% 			% \end{align*}
	% 			\begin{align*}
	% 				\gamma(x_1) &=\left[\begin{array}{ccl} a &\mapsto& \{x_1,x_2\}\\ b&\mapsto &\{x_2\}\end{array}\right] \\
	% 				\gamma(x_2) &=\left[\begin{array}{ccl} a &\mapsto& \{x_1\}\\ b&\mapsto &\emptyset\end{array}\right]
	% 			\end{align*}
	% 		\end{multicols}
	% 		から決定的オートマトン
	% 		$\delta=(F\mu_X\circ \lambda_{TX}\circ T\gamma): \mathcal P(X)\to\mathcal P(X)^A$ 
	% 		を構成することができる。
	% 		\begin{multicols}{2}
	% 			\begin{center}\small
	% 				\begin{tikzcd}[row sep=-16pt]
	% 					{\!\!\!\!\!} \ar[r,shorten <= 2mm] & \circled{\small $\{x_1\}$}  \ar[rd,"a"] & {}
	% 					\\&& \doublecircled{\scriptsize $\{x_1,x_2\}$} \ar[loop right,looseness = 1.5mm, "a"] \ar[ld,"b"] \\
	% 					& \doublecircled{\small$\{x_2\}$} \ar[uu,"a",shift left=1mm] \ar[uu, leftarrow, "b"', shift right=1mm]
	% 				\end{tikzcd}
	% 			\end{center}
	% 			\begin{align*}
	% 				\delta(\{x_1\}) &=\left[\begin{array}{ccl} a &\mapsto& \{x_1,x_2\}\\ b&\mapsto &\{x_2\}\end{array}\right] \\
	% 				\delta(\{x_2\}) &= \left[\begin{array}{ccl} a &\mapsto& \{x_1\}\\ b&\mapsto &\emptyset\end{array}\right]
	% 				\\
	% 				\delta(\{x_1,x_2\}) &=\left[\begin{array}{ccl} a &\mapsto& \{x_1,x_2\}\\ b&\mapsto &\{x_2\}\end{array}\right]
	% 			\end{align*}
	% 		\end{multicols}
	% なお、両者の捉え方がいずれも同じものであることは直ちにわかる。
	% \begin{prooftree}
	% 	\AXC{$X\to\mathcal P(X)^{A}$} \doubleLine \RL{curry}
	% 	\UIC{$X\times A\to\mathcal P(X)$} \doubleLine \RL{classify}
	% 	\UIC{$\textrm{relation}\subseteq (X\times A)\times X$} \doubleLine \RL{associate}
	% 	\UIC{$\textrm{relation}\subseteq X\times (A\times X)$} \doubleLine \RL{classify}
	% 	\UIC{$X\to\mathcal P(A\times X)$}
	% \end{prooftree}
\end{example}

% \clearpage

\begin{example}
	マルコフ連鎖は、余代数 $\gamma:X\to \mathcal D(X)$ で与えられる。なお、関手 $\mathcal D:\Set\to\Set$ は
	\begin{align*}\mathcal D(X)&=\{d:X\to [0,1]\mid\textrm{finite support,~}\textstyle\sum d(x)=1\}\\&=\{\textstyle\,\sum p_i\ket{x_i}\,\textrm{, where $p_i$ is a probability $d(x_i)\in[0,1]$.}\}\\\mathcal D(f)&:\mathcal D(X)\to\mathcal D(Y)\\&\mathcal D(f)(\textstyle\sum p_i\ket{x_i})=\textstyle\sum p_i\ket{f(x_i)}\end{align*}
	と定められているものとする。
	\begin{center}
		\begin{tikzcd}[row sep=-7pt]
			\circled{$x_1$} \ar[rd,shift left,"0.3"] \ar[dd,"0.5"'] \ar[loop above, looseness=5,"0.2"] & \\
			& \circled{$x_2$} \ar[dl,"0.7"] \ar[ul,"0.3",shift left=1mm] \\
			\circled{$x_3$} \ar[loop below,looseness=5, "1"] 
		\end{tikzcd}
		\quad \begin{align*}\gamma(x_1) & =0.2\ket{x_1}+0.3\ket{x_2}+0.5\ket{x_3},\\\gamma(x_2) & = 0.3\ket{x_1}+0.7\ket{x_3}, \\ \gamma(x_3) & = \ket{x_3}. \end{align*}
	\end{center}
\end{example}

\begin{remark}[分布関手のためのケット記法]
	% 分布に対して次の記法を用いる。
	$\mathcal D(X)=\{\, d: X \to [0,1]\mid \sum d(x)=1 \,\}$ の各要素を $\sum p_i\lvert x_i\rangle$ と書く。ここで $p_i$ は確率 $d(x_i)\in[0,1]$ である。例えば、コイントス $X=\{H,T\}$ を考えるとき、「公平なコイン」の分布は $d=\tfrac12\lvert H\rangle+\tfrac12\lvert T\rangle$ と書ける。ここで $\lvert H\rangle=\left(\begin{smallmatrix}1\\0\end{smallmatrix}\right)$、$\lvert T\rangle=\left(\begin{smallmatrix}0\\1\end{smallmatrix}\right)$ である。
\end{remark}

\clearpage

\subsection{「効果つき計算」について}
\noindent 前節でいくつか例を挙げながら紹介したように、余代数 (coalgebra) は「1ステップの状態遷移」を表しています。\[c:X\to F(X)\] より一般に、計算 (computation) は以下で表されます。（$X=Y$ とすれば余代数です。）\[c:X\to F(Y)\] ここで「ただの関数」(pure function) と「効果つき計算」(effectful computation) を区別しておくことは重要です。%\[\textrm{pure function} \quad f:X\to Y \qquad \textrm{vs} \qquad \textrm{effectful computation} \quad c:X\to F(Y)\]
\begin{framed}
\[\textrm{pure function} \qquad \textrm{vs} \qquad \textrm{effectful computation}\] 
\[f:X\to Y \qquad\qquad\quad\qquad c:X\to F(Y)\]
\end{framed}
% \begin{center}
% \begin{tabular}{ccc}
% 	pure function & vs & effectful computation \\
% 	$f:X\to Y$ && $c:X\to F(Y)$
% \end{tabular}
% \end{center}

\noindent なお、効果つき計算 $c:X\to F(Y)$ を便宜的に $c:X\computationrightarrow Y$ と表記することもあります。（厳密に言えば、これはモナド $F$ のクライスリ圏における射を表す記法ですが、ここでは詳細の説明は省略します。）\\

\subsection{グロタンディーク・ファイブレーション入門}

さて本節では、次節以降で使う「グロタンディーク・ファイブレーション」をごく簡単に導入します。複雑に見えるかもしれませんが、これを使うと、述語変換子
やループ不変量
を「引き戻し」と「持ち上げ」によって統一的に書けます。

ここでは、まず直観を説明してから、後ほど正確な定義を述べます。例として $p:\Pred\to\Set$ というファイブレーションを考えてみましょう。ひとつずつステップを踏んで理解していきます。

\begin{enumerate}
	\item それぞれの対象 $X\in\Set$ に対して、「ファイバー」(fiber) と呼ばれる完備束 $\Pred_X\;(:=2^X)$ を割り当てます。
	\begin{center}
			\begin{tikzpicture}[auto,scale=0.55]
				\draw (-4,3) -- (-4,8) -- (-0.5,8) -- (-0.5,3) --cycle; % X
				\draw (0,1.5) -- (0,6.5) -- (3.5,6.5) -- (3.5,1.5) --cycle; % Z
				\draw (4,2.5) -- (4,7.5) -- (7.5,7.5) -- (7.5,2.5) --cycle; % Y
				%%%===
				\node[above] (predx) at (-2.25,8) {$\scriptstyle\Pred_X\;(=2^X)$};
				\node[above] (predz) at (1.75,6.5) {$\scriptstyle\Pred_Z\;(=2^Z)$};
				\node[above] (predy) at (5.75,7.5) {$\scriptstyle\Pred_Y\;(=2^Y)$};
				%=====
				\node (X) at (0,-0.5) {$X$};
				\node (Y) at (4,-0.5) {$Y$};
				\node (Z) at (2,-2.0) {$Z$};
				\draw [->] (X) -- node[above]{$\scriptstyle f$} (Y);
				\draw [->] (Y) -- node[below right]{$\scriptstyle g$} (Z);
				%=====
				\node (xphi) at (-2.5,3.5) {$\scriptstyle(\emptyset\subseteq X)$};
				\node (xpdash) at (-1.5,4.75) {$\scriptstyle(P'\subseteq X)$};
				\node (xp) at (-3,6) {$\scriptstyle(P\subseteq X)$};
				\node (xx) at (-2.5,7.5) {$\scriptstyle(X\subseteq X)$};
				\draw[->] (xphi) -- (xpdash);
				\draw[->] (xphi) -- (xp);
				\draw[->] (xpdash) -- (xp);
				\draw[->] (xp) -- (xx);
				%===
				\node (zphi) at (1.5,2) {$\scriptstyle(\emptyset\subseteq Z)$};
				\node (zpdash) at (2.5,3.25) {$\scriptstyle(R'\subseteq Z)$};
				\node (zp) at (1.0,4.5) {$\scriptstyle(R\subseteq Z)$};
				\node (zz) at (1.5,6) {$\scriptstyle(Z\subseteq Z)$};
				\draw[->] (zphi) -- (zpdash);
				\draw[->] (zphi) -- (zp);
				\draw[->] (zpdash) -- (zp);
				\draw[->] (zp) -- (zz);
				%===
				\node (yphi) at (5.5,3) {$\scriptstyle(\emptyset\subseteq Y)$};
				\node (ypdash) at (6.5,4.25) {$\scriptstyle(Q'\subseteq Y)$};
				\node (yp) at (5,5.5) {$\scriptstyle (Q\subseteq Y)$};
				\node (yy) at (5.5,7) {$\scriptstyle(Y\subseteq Y)$};
				\draw[->] (yphi) -- (ypdash);
				\draw[->] (yphi) -- (yp);
				\draw[->] (ypdash) -- (yp);
				\draw[->] (yp) -- (yy);
				%===
				\node (xbottom) at (-2.5,3) {};
				\node (zbottom) at (1.5,1.5) {};
				\node (ybottom) at (5.5,2.5) {};
				\draw (xbottom) to[bend right=15pt] (X);
				\draw[cross] (zbottom) to[bend right=18pt] (Z);
				\draw (ybottom) edge[bend left=16pt] (Y);
			\end{tikzpicture}
		\end{center}
	\item それぞれの射 $f:X\to Y$ に対して、$f^\ast:\Pred_Y\to\Pred_X$ を定めます。
	% \begin{small}
		\[
		\begin{array}{cccc}
			f^\ast:&2^Y&\longrightarrow&2^X\\[0pt]&\rotatebox{90}{$\in$}&&\rotatebox{90}{$\in$}\\[-2pt]&(Y\xrightarrow{g} 2)&{\;\longmapsto\;}&(X\xrightarrow{f}Y\xrightarrow{g} 2)
		\end{array}
		\] 
		この $f^\ast$ が、$f$ による述語変換子にあたるものです。（後ほど説明します。）
		\begin{center}
			\begin{tikzcd}
				\scriptstyle\Pred_X & \scriptstyle\Pred_Y \\[-22pt]
				\;\fbox{$\substack{~~~~~~\\~~~~\\~~~~\\P'~~~~~~\\[-2pt]~~~~~~~P''\\~\nwarrow~~~~~\\[-4pt]~~~~~\nearrow~~\\[3pt]~~P~~~\\~~~}$}\; \ar[d,dash,bend right=12pt]  & \;\fbox{$\substack{~~~~~~\\~~~~\\~~~\\~~~~~~Q'~\\~~~~~\\~~\nearrow~~\\~~~\\~~Q~~~~~\\~~~}$}\; \ar[d,dash,bend left=12pt] \ar[l,"f^\ast"'] \\[5pt]
				X \ar[r,"f"] & Y
			\end{tikzcd}
		\end{center}
	% \end{small}
	\item 以上で与えられたデータ $\Bigl((\Pred_X)_{X\in\Set}\,,\,(f^\ast:\Pred_Y\to\Pred_X)_{f:X\to Y\,\textrm{in}\,\Set}\Bigr)$ をもとに、ファイバーを貼り合わせて、「全体圏」(total category) と呼ばれる圏 $\Pred$ をつくります。
	\begin{small}
		\begin{center}
			\begin{tikzcd}
				\Pred \ar[d,"p"'] & \fbox{$\!\!\!\!\!\!\!\substack{~~~~~~~~~\\~~~~~\\~~~~~\\P'~~~~~~\\[-2pt]~~~~~P''~~~\\[-4pt]~~~~~~~~~~~~~~f^\ast \!(Q)\\[-2pt]~\rotatebox{130}{$\scriptstyle\longrightarrow$}~~~~~\\[-10pt]~~~~~~~~\rotatebox{98}{$\scriptstyle\longrightarrow$}~\nearrow~~~~\\[3pt]~~~~~~~P~~~~\\~~~~~~~~~~~~~~~~~}~\!\!\!\!\substack{~~\\~~\\~~\\~~\\\rotatebox{-20}{~$\longrightarrow$}\\~~\\\rotatebox{20}{$\longrightarrow$~}}\!\!\!\!\!\!\!\!\substack{\vdots\\[-4pt]\vdots\\[-4pt]\vdots\\[-4pt]\vdots\\[-4pt]\vdots\\~}~~~\substack{~~~~~~\\~~~~\\~~~\\~~~~~~Q'~\\~~~~~\\~~\nearrow~~\\~~~\\~~Q~~~~~\\~~~\\~~~\\~~~~~}~~~~$}\\
				\Set & X\xrightarrow{\qquad f \qquad} Y 
			\end{tikzcd}
		\end{center}
	\end{small}
	\item この $\Pred$ は、対象が組 $(X,\,P\subseteq X)$ であり、射が写像 $(X,\,P\subseteq X)\to(Y,\,Q\subseteq Y)$ であるような圏です。
	\begin{itemize}
		\item 対象: \[\left|\Pred\right|=\coprod_{X\in\Set}\left|\Pred_X\right|\]
		\item 射: 
			% \begin{small}
				\begin{prooftree}
					\AXC{$(X,\,P\subseteq X)\longrightarrow (Y,\,Q\subseteq Y)$ in $\Pred$}
					\doubleLine
					\UIC{$X\xrightarrow{\;f\;}Y$ in $\Set$ s.t. $P\sqsubseteq f^\ast (Q)$ in $\Pred_X$}
				\end{prooftree}
				% \end{small}
		\end{itemize}\vspace{5pt}
	\item 以下の条件を満たす関手 $p:\Pred\to\Set$ は「ファイブレーション」(fibration) と呼ばれます。（詳細は後述）
	\begin{small}
		\begin{center}
			\!\!\!\!\!\!
			\begin{tikzcd}[row sep=-2pt,column sep=11.5pt]
				 & &&&&&& R \ar[rrd,bend left=15pt,"\forall\,r"] \ar[rd,dashed,"{}{\exists !\,} s\!\!\!"',shorten >= -7pt] \ar[ddd,mapsto] && \\
				\Pred \ar[ddd,"p"'] &&Q \ar[ddd,mapsto] && ~{}^{\exists}f^\ast\!(Q)~ \ar[r,"\exists\,\overline{f}(Q)~"',shorten=-4pt] \ar[ddd,mapsto] & ~Q~ \ar[ddd,mapsto] &&& ~f^\ast\!(Q)~ \ar[r,"\overline f(Q)"',shorten=-3pt] \ar[ddd,mapsto] & ~Q~ \ar[ddd,mapsto]\\
				&&&\hspace*{-8pt}\implies\hspace*{-8pt} &&& \hspace*{-5pt}\textrm{s.t.}\hspace*{-5pt} &&&\\
				&&&&&&& p(R) \ar[rd,"\forall\,g"'] \ar[rrd,bend left=15pt,pos=0.65,"g\circ f"] && \\
				\Set & \,X\, \ar[r,"f"',shorten=-3pt] & \,Y\, && X \ar[r,"f"'] & Y &&& X \ar[r,"f"'] & Y
			\end{tikzcd}
			\!\!\!\!\!\!
		\end{center}
	\end{small}
	\item ここで、$\Pred$ を「全体圏」といい、$\Set$ を「基底圏」といいます。\\ また、$\overline{f}(Q)$ を、$f$ の $Q$ による「カルテシアン持ち上げ」(cartesian lifting) といいます。\\ $f^\ast$ を、$f$ の「置換」(substitution) といい、対象 $P,Q\in\Pred$ で $pP=pQ=Y$ なるものと、$\Pred$ の射 $(P\xrightarrow{u}Q)$ で $pu=\id_Y$ なるものについて、$\overline f_Q\circ f^\ast u=u\circ\overline f_P$ を満たすものと定められています。
	\begin{center}
		\begin{tikzcd}
				& f^\ast P \ar[d,"f^\ast u"'] \ar[r,"\overline f_P"] & P \ar[d,"u"] \\
			\Pred \ar[d,"p"'] & f^\ast Q \ar[r,"\overline f_Q"'] & Q \\
			\Set &X \ar[r,"f"'] & Y
		\end{tikzcd}
	\end{center}
	\clearpage
	\item ここで、$(-)^*$ や $\overline{(-)}$ は ``関手的'' (functorial)、つまり恒等射と合成に整合します。
	\begin{small}
	\begin{align*}
		\begin{array}{rlcrl}
			\id_Y^\ast Q & = Q, & \quad\qquad & (g\circ f)^\ast(Q) & =f^\ast(g^\ast Q), \\[3pt]
			\overline{\id_Y}(Q) & = \id_Q, & & \overline{g\circ f}(Q) &=\overline gQ\circ\overline f(g^\ast Q).
		\end{array}
	\end{align*}
	\end{small}
	\item 自己関手 $F:\Set\to\Set$ と、ファイブレーション $p:\Pred\to\Set$ について、\\ 関手 $\dot{F}:\Pred\to\Pred$ が、$p$ に沿った $F$ の「持ち上げ」(fibred lifting) であるとは、
	\begin{center}
		\begin{small}
			\begin{tikzcd}[row sep=18pt]
				\Pred \ar[r,"\dot F"] \ar[d,"p"'] & \Pred \ar[d,"p"] \ar[ld,"\rotatebox{45}{$=$}",phantom]\\
				\Set \ar[r,"F"'] & \Set
			\end{tikzcd} 
			\quad かつ \quad
			\begin{tikzcd}[column sep=28pt,row sep=18pt]
				\Pred_Y \ar[r,"f^\ast"] \ar[d,"\dot F"'] & \Pred_X \ar[d,"\dot F"] \ar[ld,phantom,"\rotatebox{40}{$\cong$}"',shorten=12pt] \\
				\Set_{FY} \ar[r,"(Ff)^\ast\;"'] & \Set_{FX}
			\end{tikzcd}
		\end{small}
	\end{center} 
	を満たすことです。特に余代数との関わりの中では、以下の図のような状況を考えることが多いです。基底の関手 $F$ をどうやって $\dot F$ に持ち上げるかが重要になります。（後述）
	\begin{small}
		\begin{center}
			\begin{tikzcd}
				\Pred \ar[loop left,"\dot F"] \ar[d,"p"'] & \Pred_{X} \ar[rr,bend left=12pt,"\dot F_X"] && \Pred_{\,FX} \ar[ll,bend left=12pt,"c^\ast"] \\
				~\Set~ \ar[loop left,"F"]  & X \ar[rr,"c"'] && FX 
			\end{tikzcd}
		\end{center}
	\end{small}
	% \item 
\end{enumerate}

\begin{center}
	\hrulefill
\end{center}

\noindent 以下、ファイブレーションの正確な定義を（念のため）書いておきます。ですが、上記の $p:\Pred\to\Set$ の考え方だけをきちんと押さえておけば、次節以降の内容を理解するうえで基本的には問題ないです。

\begin{definition}[カルテシアン]
	$p:\E\to\B$ を関手とします。$\E$ の射 $(X\xrightarrow{f}Y)$ が $p$-カルテシアン ($p$-cartesian) であるとは、すべての $Z\in\E$ について、以下のプルバック図式が可換になることである。
	\begin{multicols}{2}
		\begin{small}
		\begin{center}
			\begin{tikzcd}[row sep=30pt,column sep=35pt]
				\E(Z,X) \ar[r,"f\circ(-)"] \ar[d,"p_{ZX}"']  \arrow[dr, phantom, "\lrcorner", very near start] & \E(Z,Y) \ar[d,"p_{ZY}"] \\
				\B(pZ,pX) \ar[r,"pf\circ(-)"'] & \B(pZ,pY) 
			\end{tikzcd}
		\end{center}
		\end{small}
		% ~\\
		\begin{small}
		\begin{center}
			\quad i.e. \quad 
			\begin{tikzcd}
				\exists!\,h \ar[r,mapsto] \ar[d,mapsto] & \forall\, g \ar[d,mapsto]\\
				\forall\,u \ar[r,mapsto] & \substack{\displaystyle ~~~~pg \\ \displaystyle\rotatebox{45}{$=~$}\\\displaystyle pf\circ u~~~~~~\\[3pt]\displaystyle~~~}
			\end{tikzcd}
		\end{center}
		\end{small}
	\end{multicols}
\end{definition}

\begin{remark}
	要するに以下と同じ。
	\begin{small}
	\begin{center}
		\begin{tikzcd}[row sep=3pt,column sep=20pt]
			& Z \ar[rrd,bend left=15pt,"\forall\,g"] \ar[rd,dashed,"{}{\exists !\,} h\!\!\!"']  && \\
			~\E~ \ar[ddd,"p"'] && X \ar[r,"f"']  & Y \\
			&&\\[5pt]
			& pZ \ar[rd,"\forall\,u"'] \ar[rrd,bend left=15pt,pos=0.65,"pg"] && \\
			~\B~ && pX \ar[r,"pf"'] & pY
		\end{tikzcd}
	\end{center}
	\end{small}
\end{remark}

\begin{definition}[ファイブレーション]
	関手 $p:\E\to\B$ がファイブレーション (fibration) であるとは、$\B$ の任意の射 $u:I\to J$ と、$J$ の上にある（つまり $pY=J$ であるような）任意の対象 $Y\in\E$ に対し、$\E$ の $p$-カルテシアン射 $f:X\to Y$ が $u$ の上に存在する（つまり $pf=u$である）ことである。
\end{definition}

\begin{remark}
	要するに以下と同じ。
	\begin{small}
	\begin{center}
		\begin{tikzcd}[column sep=35pt,row sep=16pt]
			\E \ar[d,"p"'] & & Y \ar[rd,"\implies",phantom] & \exists\, X \ar[r,"\exists\,f"',"\textrm{cartesian~\,}"] & Y \\
			\B & I \ar[r,"u"'] & J & I \ar[r,"u"'] & J
		\end{tikzcd}
	\end{center}
	\end{small}
\end{remark}

\begin{definition}[ファイバー]
	$p:\E\to\B$ を関手とする。各対象 $I\in\B$ について、圏 $\E_I$ をファイバー (fiber) と呼ぶ。対象は、$I$ の上にある（つまり $pX=I$ を満たすような）$X\in\E$ であり、射は $\id_I$ の上にある（つまり$pf=\id_I$ を満たすような） $\E$ の射 $f:X\to Y$ である。
\end{definition}

% \clearpage

\begin{definition}[置換]
	$p:\E\to\B$ をファイブレーションとし、$u:I\to J$ を $\B$ の射とします。$u$ の置換 (substitution) とは、関手 $u^\ast:\E_J\to\E_I$ であって以下を満たすものである。（ここで、$\overline u_X:u^\ast X\to X$ は$p$-カルテシアン射であって $p(\overline u_X)=u$ を満たすものである。）\vspace{3pt}
	\begin{center}
		\begin{tikzcd} 
			u^*X \ar[d,"u^*f"',dashed] \ar[r,"\overline u_X"] & X \ar[d,"f"] \\ u^*Y \ar[r,"\overline u_Y"] & Y \\[-8pt]
			I \ar[r,"u"] & J
		\end{tikzcd}
	\end{center}
	\begin{itemize}
		\item 対象 $X\in\E_J$ に対し、対象 $u^\ast X\in\E_I$ を返し、
		\item $\E_J$ の射 $f:X\to Y$ に対し、射 $u^\ast f:u^\ast X\to u^\ast Y$ が一意に定まり、以下のプルバック図式を満たす：
		\begin{center}
		\begin{small}
			\begin{tikzcd}[column sep=38pt,row sep=30pt]
				% \E(u^\ast X,u^\ast Y) \ar[r,"{\E(u^{\!*\!} X,\overline{u}_Y)}"] \ar[d,"p\circ(-)"'] \arrow[dr, phantom, "\lrcorner", very near start] & \E(u^\ast X,Y) \ar[d,"p\circ(-)"] \\
				\E(u^\ast X,u^\ast Y) \ar[r,"\overline{u}_Y\circ(-)"] \ar[d,"p"'] \arrow[dr, phantom, "\lrcorner", very near start] & \E(u^\ast X,Y) \ar[d,"p"] \\
				% \B(I,I) \ar[r,"{\B(I,u)}"'] & \B(I,J)
				\B(I,I) \ar[r,"u\circ(-)"'] & \B(I,J)
			\end{tikzcd}
		% \end{small}
		\qquad\quad i.e. \quad 
		% \begin{small}
			\begin{tikzcd}[column sep=32pt,row sep=25pt]
				\exists !\,u^\ast f \ar[r,mapsto,"\textrm{\ajMaru{2}}"] \ar[d,mapsto,"\textrm{\ajMaru{1}}"'] & f\circ\overline{u}_X \ar[d,mapsto] \\ 
				\id_I \ar[r,mapsto] & u 
			\end{tikzcd}
		\end{small}
		\end{center}
		すなわち、\textrm{\ajMaru{1}} $p(u^\ast f)=\id_I$ と \textrm{\ajMaru{2}} $f\circ\overline{u}_X=\overline{u}_Y\circ u^\ast f$ を満たす。
	\end{itemize}
\end{definition}

\begin{remark}
	同一の射の上にあるカルテシアン射は ``一意な同型を除いて一意'' (unique up to unique iso) である。より具体的に言うと、ファイブレーション $p:\E\to\B$ と、$\B$ の射 $u:I\to J$ が与えられ、$Y\in\E_J$ があり、2つの $p$-カルテシアン射 $\overline{u}_Y:u^\ast Y\to Y$ と $f:X\to Y$ がいずれも $u$ の上にあるとき、一意な同型射 $\alpha:X\xrightarrow{\cong} u^\ast Y$ がファイバー $\E_I$ に存在し、$f=\overline u_Y\circ\alpha$ が成り立つ。
	\begin{small}
	\begin{center}
		\begin{tikzcd}
			& X \ar[r,"f"] \ar[d,shift right=5pt,"~\rotatebox{-90}{$\cong$}",dashed,phantom] & Y \ar[d,"\rotatebox{90}{$=$}",phantom] \\[-5pt]
			\E \ar[d,"p"'] & u^\ast Y \ar[r,"\overline u_Y"'] & Y \\[-3pt]
			\B & I \ar[r,"u"] & J
		\end{tikzcd}
	\end{center}
	\end{small}
\end{remark}

\begin{proposition} \label{prop:gamma-nat-trans}
	$p:\E\to\B$ をファイブレーションとする。$F:\B\to\B$, $\dot F:\E\to\E$ をそれぞれ $\B, \E$ の自己関手とし、$p\circ\dot F=F\circ p$を満たすものとする。
	\begin{small}
	\begin{center}
		\begin{tikzcd}[column sep=16pt,row sep=16pt]
			\E \ar[r,"\dot F"] \ar[d,"p"'] & \E \ar[d,"p"] \\
			\B \ar[r,"F"'] & \B
		\end{tikzcd}
	\end{center}
	\end{small}
	このとき、$\B$ の任意の射 $(I\xrightarrow{u}J)$ に対し、以下の自然変換 $\gamma:\dot F\circ u^\ast\Rightarrow(Fu)^\ast\circ\dot F$ が存在する。\vspace{-5pt}
	\begin{multicols}{2}
		\begin{small}
		\begin{center}
			~\\[-2pt]
			\begin{tikzcd}[column sep=32pt,row sep=25pt]
				\E_J \ar[r,"u^\ast"] \ar[d,"\dot F"'] & \E_I \ar[d,"\dot F"] \ar[ld,Rightarrow,"\gamma"',shorten=12pt] \\
				\E_{FJ} \ar[r,"(Fu)^\ast"'] & \E_{FI}
			\end{tikzcd}
		\end{center}
		\end{small}
		%
		\begin{small}
		\begin{center}
			i.e.\quad 
			\begin{tikzcd}[row sep=10pt]
				X \ar[r,mapsto,"u^\ast"] \ar[dd,mapsto] & u^\ast X \ar[d,mapsto] \\
				& \dot F(u^\ast X) \ar[d,"\gamma_X"]\\
				\dot FX \ar[r,mapsto] & (Fu)^\ast \dot FX
			\end{tikzcd}
		\end{center}
		\end{small}
	\end{multicols}
\end{proposition}

\begin{proof}
	$X\xmapsto{\,(pX=J)\,}J$ および $\dot FX\xmapsto{\,(p\dot FX=FpX=FJ)\,}FJ$ と考えると、
	\begin{small}
	\begin{center}
		\begin{tikzcd}
			\E \ar[loop left, "\dot F"] \ar[d,"p"'] & u^\ast X \ar[r,"\overline u"] & X \\
			\B \ar[loop left, "F"] & I \ar[r,"u"'] & J  
		\end{tikzcd}
		\;$\longmapsto$\;
		\begin{tikzcd}
			\dot F(u^\ast X) \ar[r,"\dot F\,\overline u"] & \dot FX \\
			FI \ar[r,"u"'] & FJ  
		\end{tikzcd}
	\end{center}
	\end{small}
	が得られる。それゆえ、
	\begin{small}
	\begin{center}
		\begin{tikzcd}
			& \dot F(u^\ast X) \ar[rd,"\dot F\,\overline u",bend left=12pt] \ar[d,dashed,"\gamma_X"'] &  \\ 
			\E \ar[d,"p"'] & (Fu)^\ast \dot FX \ar[r,"\overline{Fu}"'] & \dot FX \\
			\B & FI \ar[r,"Fu"'] & FJ
		\end{tikzcd}
	\end{center}%\vspace{-6pt}
	\end{small}
	となる。（なお、$\gamma$ の自然性の証明はここでは省略する。）
\end{proof}

\begin{definition}[カルテシアンを保つ] \label{def:preserving-cartesian}
	$p:\E\to\B$ をファイブレーションとする。関手 $\dot F:\E\to\E$ が $p$-カルテシアンを保つ (preserves $p$-cartesian) とは、$\dot F$ が各 $p$-カルテシアン射 $f$ を別の $p$-カルテシアン射 $\dot Ff$ に送ること。\vspace{5pt}%つまり、
	\begin{center}$(X\xrightarrow{f}Y)$ in $\E$ is $p$-cartesian $\implies$ $(\dot FX\xrightarrow{\dot Ff}\dot FY)$ in $\E$ is $p$-cartesian.\end{center}
\end{definition}

\begin{proposition}
	$p:\E\to\B$ をファイブレーションとする。$F:\B\to\B$, $\dot F:\E\to\E$ をそれぞれ $\B, \E$ の自己関手とし、$p\circ\dot F=F\circ p$を満たすものとする。（ここまでの状況は、先ほどの\textgt{命題\ref{prop:gamma-nat-trans}}のときと同じ。）
	\begin{small}
	\begin{center}
		\begin{tikzcd}[column sep=16pt,row sep=16pt]
			\E \ar[r,"\dot F"] \ar[d,"p"'] & \E \ar[d,"p"] \\
			\B \ar[r,"F"'] & \B
		\end{tikzcd}
	\end{center}
	\end{small}
	このとき、以下の同値関係が成り立つ。\vspace{5pt}
	\begin{center}
	$\dot F$ preserves $p$-cartesian $\iff$ $\gamma:\dot F\circ u^\ast\Rightarrow(Fu)^\ast\circ\dot F$ is isomorphic. \end{center}
\end{proposition}

\begin{proof}
	任意の $p$-カルテシアン射 $f:X\to Y$ をとり、以下の状況を考える。
	\begin{center}
		\begin{small}
			\begin{tikzcd}[column sep=32pt,row sep=28pt]
				\E_{pY} \ar[r,"(pf)^\ast"] \ar[d,"\dot F"'] & \E_{pX} \ar[d,"\dot F"] \ar[ld,Rightarrow,"\gamma"',shorten=12pt] \\
				\E_{FpY} \ar[r,"(Fpf)^\ast"'] & \E_{FpX}
			\end{tikzcd}
			\qquad i.e. \qquad 
			\begin{tikzcd}[row sep=12pt]
				Y \ar[r,mapsto] \ar[dd,mapsto] & X \ar[d,mapsto] \\
				& \dot FX \ar[d,"\gamma_Y"]\\[4pt]
				\dot FY \ar[r,mapsto] & (Fpf)^\ast \dot FY
			\end{tikzcd}
		\end{small}
	\end{center}
	言い換えると、状況は以下のとおり。\vspace{-5pt}
	\begin{center}
		\begin{small}
			\begin{tikzcd}
				&&&& \dot FX \ar[rd,bend left=15pt,"\dot Ff"] \ar[d,"\gamma_Y"',dashed] & \\
				\E \ar[d,"p"'] & X \ar[r,"\substack{\overline{pf}\\\rotatebox{90}{$\,=\,$}\\f}"] & Y \ar[rrd,"\longmapsto",phantom] && (Fpf)^\ast FY \ar[r,"\overline{Fpf}"'] & \dot FY\\[-5pt]
				\B & pX \ar[r,"pf"'] & pY && FpX \ar[r,"Fpf"'] & FpY
			\end{tikzcd}
		\end{small}
	\end{center} 
	ここで、$\dot Ff$ が $p$-カルテシアンである $\iff$ $\gamma_Y$ が同型射である。（なぜなら、$\dot Ff$ と $\overline{Fpf}$ はいずれも $Fpf$ の上にあり、しかも $\overline{Fpf}$ は定義からして $p$-カルテシアンであるので、($\Rightarrow$): もし $\dot Ff$ も $p$-カルテシアンなら、一意な同型射 $\gamma_Y$ が手に入るし、($\Leftarrow$): もし $\gamma_Y$ が同型射なら、$\dot Ff$ は $p$-カルテシアンである。）
	% Here, $\dot Ff$ is $p$-cartesian iff $\gamma_Y$ is isomorphic. (Because both of $\dot Ff$ and $\overline{Fpf}$ are above $Fpf$, and $\overline{Fpf}$ is $p$-cartesian by definition, thus ($\Rightarrow$): if $\dot Ff$ is also $p$-cartesian, then we have a unique isomorphism $\gamma_Y$; and ($\Leftarrow$): if $\gamma_Y$ is a isomorphism, then $\dot Ff$ is also $p$-cartesian.) 
\end{proof}

\clearpage

\begin{definition}[関手の持ち上げ]
	$p:\E\to\B$ をファイブレーションとする。$F:\B\to\B$ を $\B$ における自己関手とする。このとき、$\E$ における自己関手 $\dot F:\E\to\E$ が $p$ に沿った $F$ のファイバー持ち上げ (fibered lifting) であるとは、$p\circ \dot F=F\circ p$ を満たし、かつ $\dot F$ がカルテシアンを保つ（cf. \textgt{定義\ref{def:preserving-cartesian}}）ことである。
\end{definition}

\begin{remark}
	つまり、$\dot F$ は ~
	\begin{small}
		\begin{tikzcd}
			\E \ar[r,"\dot F"] \ar[d,"p"'] & \E \ar[d,"p"] \ar[ld,"\rotatebox{45}{$=$}",phantom]\\
			\B \ar[r,"F"'] & \B
		\end{tikzcd} 
	\end{small}
	~ と ~
	\begin{small}
		\begin{tikzcd}[column sep=22pt]
			\E_J \ar[r,"u^\ast"] \ar[d,"\dot F"'] & \E_I \ar[d,"\dot F"] \ar[ld,phantom,"\rotatebox{40}{$\cong$}"',shorten=12pt] \\
			\E_{FJ} \ar[r,"(Fu)^\ast\;"'] & \E_{FI}
		\end{tikzcd}
	\end{small}
	を満たす。
\end{remark}

\clearpage

\section{最弱事前条件をどのように手に入れるか}

さて、本節では、非決定的プログラムや確率的プログラムなど様々な種類のプログラムに対する述語変換子意味論を手に入れる方法について、圏論的な視座から考えます。一般に、状態の集合 $X, Y$ と真理値の集合 $\Omega$ が与えられたときに、効果付き計算 $c:X\to FY$ に基づいて、事後条件 $q:Y\to\Omega$ を最弱事前条件 $wp\llbracket c\rrbracket(q):X\to \Omega$ に変換するための関数である「述語変換子」 $wp\llbracket c\rrbracket:\Omega^Y\to\Omega^X$ を得るためには、どんな手続きを経たらよいでしょうか。

いくつか例を見てから、その後に一般論を考えましょう。

\begin{example}[2値的(boolean)モデル検査の場合]

\end{example}

\clearpage

%-----
% \clearpage
\begin{thebibliography}{99}
    \item 
\end{thebibliography}
%-----


\end{document}